<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="This is my page">
    <link rel="stylesheet" href="../admin/bootstrap-3.3.7/css/bootstrap.min.css">
    <script type="text/javascript" src="../admin/bootstrap-3.3.7/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="../admin/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../admin/bootstrap-3.3.7/js/bootstrap-paginator.js"></script>
    <title>Title</title>
</head>
<body onload="listbook()">
<div class="panel panel-info">
    <div class="panel-heading">审批列表</div>
    <div class="panel-body">



    </div>
</div>

<table class="table table-bordered table-striped table-hover" id="table">
    <thead>
    <tr class="label-success">
        <th style="width:5%">序号</th>
        <th style="width:4%">流程id</th>
        <th style="width:8%">申请状态</th>
        <th style="width:8%">姓名</th>
        <th style="width:8%">邮箱</th>
        <th style="width:8%">手机</th>
        <th style="width:12%">图片名字</th>
        <th style="width: 10%">申请理由</th>
        <th style="width:4%">操作</th>
    </tr>
    </thead>
    <tbody id="tb">
    </tbody>
</table>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    发送信息:
                </h4>
            </div>
            <div class="modal-body">
                <textarea  id="messages" class="text" style="width:100%; height:200px;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button"  onclick="sendMessage()" class="btn btn-primary">
                    提交按钮
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
<script>

    //定义一个全局用户姓名变量
    var userName = "";

    function listbook() {
        $("#tb").html("");
        $.ajax({
            type: 'post',
            url: '../application/getSuccessApplication',
            contentType: 'application/json;charset=utf-8',
            success: function (result) {
                console.log(result);
                var tb = $("#tb");
                var data = result.审核成功;
                var msg = "";
                $.each(data, function (index, book) {
                    msg += "<tr>" +
                        "<td>" + book.id + "</td>" +
                        "<td>" + book.processInstanceId + "</td>" +
                        "<td>" + book.state + "</td>" +
                        "<td>" + book.name + "</td>" +
                        "<td>" + book.mail + "</td>" +
                        "<td>" + book.phone + "</td>" +
                        "<td>" + book.resumeurl + "</td>" +
                        "<td>" + book.reason + "</td>"+
                        "<td><button data-toggle='modal' data-target='#myModal'  class='btn btn-success'   onclick=estaclisConnection('"+book.name+"')>发送信息</button></td>"

                });
                tb.append(msg);
            },
            error: function () {
                alert("传输错误")
            }
        })
    }

    //建立websocket连接
    function estaclisConnection(name) {

        userName = name;
        console.log(userName);
        var table = $("#message");
        var messsag = "";
        var admin = "admin";
        var socket;
        if(typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        }else{
            console.log("您的浏览器支持WebSocket");
            socket = new WebSocket("ws://127.0.0.1:8080/websocket/"+admin);
            socket.onopen = function() {
                console.log("Socket 已打开");
            };
            socket.onmessage = function(msg) {
                console.log(msg.data);
                messsag = "<tr><td>"+msg.data+"</td></tr>";
                table.append(messsag);
            };
            socket.onclose = function() {
                console.log("Socket已关闭");
                $("#close").val("Socket已关闭")
            };
            socket.onerror = function() {
                alert("Socket发生了错误");
            }
        }
    }

    function sendMessage() {
        $.ajax({
            type: 'post',
            url: '../chat/toChat',
            contentType: 'application/json;charset=utf-8',
            data: '{"message":"' + $("#messages").val() + '","sid": "'+userName+'" ,"ownSid":"admin"}',
            success:function (data) {
                console.log(data);
            }
        })
    }

</script>
</html>